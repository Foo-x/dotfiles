# 出力フォーマット

リファクタリング分析レポートの標準形式を定義します。

## レポート構造

### 1. ヘッダーセクション

```markdown
# リファクタリング分析レポート

**分析対象**: {プロジェクト名/ディレクトリ/ファイル名}
**分析日時**: {YYYY-MM-DD HH:MM:SS}
**検出項目数**: {総数} (Critical: {数}, High: {数}, Medium: {数}, Low: {数})
**分析範囲**: {スコープの説明}
```

### 2. エグゼクティブサマリー

プロジェクト全体の健全性を一目で把握できる概要。

```markdown
## エグゼクティブサマリー

### 全体評価
- **コード品質スコア**: {0-100点} / 100点
- **保守性**: {優秀/良好/改善推奨/要改善}
- **総コード行数**: {数}行
- **分析ファイル数**: {数}ファイル

### 主要な問題
1. {最も重大な問題の簡潔な説明}
2. {2番目に重大な問題の簡潔な説明}
3. {3番目に重大な問題の簡潔な説明}

### 推奨アクション
1. {最優先で対処すべきアクション}
2. {次に対処すべきアクション}
3. {その次に対処すべきアクション}
```

### 3. サマリーテーブル

優先度別の集計表。

```markdown
## 検出項目サマリー

| 優先度 | 件数 | 主な問題カテゴリ |
|--------|------|------------------|
| Critical | {数} | {カテゴリ1, カテゴリ2, ...} |
| High | {数} | {カテゴリ1, カテゴリ2, ...} |
| Medium | {数} | {カテゴリ1, カテゴリ2, ...} |
| Low | {数} | {カテゴリ1, カテゴリ2, ...} |

### カテゴリ別内訳

| カテゴリ | 件数 | 説明 |
|----------|------|------|
| SOLID原則違反 | {数} | 単一責任、オープン・クローズド等 |
| コードスメル | {数} | Long Method, Large Class等 |
| 高複雑度 | {数} | CC > 10のメソッド |
| 重複コード | {数} | DRY原則違反 |
| 命名問題 | {数} | 不明瞭な命名 |
| その他 | {数} | - |
```

### 4. 詳細セクション

各問題の詳細な説明。優先度が高い順に記載。

```markdown
## 詳細

### [RF-{連番}] {問題のタイトル}

**ファイル**: `{ファイルパス}`
**行**: {開始行}-{終了行} または {行番号}
**優先度**: {Critical/High/Medium/Low}
**カテゴリ**: {SOLID違反/コードスメル/高複雑度/重複コード/命名/その他}
**サブカテゴリ**: {具体的な問題タイプ}
**関連原則**: {SOLID原則名、DRY、KISS等}

#### 問題の説明
{問題の詳細な説明。なぜこれが問題なのか、どのような影響があるのかを明確に記述}

#### 検出された指標
{該当する場合のみ}
- **循環的複雑度**: {数値}
- **認知的複雑度**: {数値}
- **行数**: {数値}
- **結合度**: {評価}
- **凝集度**: {評価}

#### 現在のコード
```{言語}
{問題のあるコードを抜粋}
```

#### 改善後のコード
```{言語}
{リファクタリング後のコード例}
```

#### 改善の効果
- {効果1: 具体的な改善内容}
- {効果2: 具体的な改善内容}
- {効果3: 具体的な改善内容}

#### 実装の影響範囲
- **変更ファイル数**: {推定数}
- **影響するテスト**: {テストファイル名やテストケース数}
- **破壊的変更**: {あり/なし}
- **推定工数**: {小/中/大}

---
```

### 5. メトリクスサマリー（オプション）

定量的な品質指標の集計。

```markdown
## メトリクスサマリー

### 複雑度分布

| CC範囲 | 関数数 | 割合 |
|--------|--------|------|
| 1-5 (低) | {数} | {%} |
| 6-10 (中) | {数} | {%} |
| 11-20 (高) | {数} | {%} |
| 21+ (極めて高い) | {数} | {%} |

### 最も複雑な関数 Top 5

| ファイル | 関数名 | CC | 行数 |
|----------|--------|----|----|
| {ファイル} | {関数} | {数} | {数} |
| ... | ... | ... | ... |

### ファイルサイズ分布

| 行数範囲 | ファイル数 | 割合 |
|----------|-----------|------|
| 0-100 | {数} | {%} |
| 101-300 | {数} | {%} |
| 301-500 | {数} | {%} |
| 501+ | {数} | {%} |

### 最も大きなファイル Top 5

| ファイル | 行数 | クラス数 | 関数数 |
|----------|------|---------|--------|
| {ファイル} | {数} | {数} | {数} |
| ... | ... | ... | ... |
```

### 6. 推奨実装順序

リファクタリングの実施順序を提案。

```markdown
## 推奨実装順序

### フェーズ1: 緊急対応（Critical優先度）
期間: {推定期間}

1. **[RF-001] {タイトル}**
   - 理由: {なぜ最優先か}
   - 依存関係: なし

2. **[RF-003] {タイトル}**
   - 理由: {なぜ優先か}
   - 依存関係: RF-001の完了後

### フェーズ2: 重要な改善（High優先度）
期間: {推定期間}

1. **[RF-002] {タイトル}**
   - 理由: {なぜ優先か}
   - 依存関係: フェーズ1完了後

### フェーズ3: 段階的改善（Medium優先度）
期間: {推定期間}

{Medium優先度の項目リスト}

### フェーズ4: 細かい改善（Low優先度）
期間: {推定期間}

{Low優先度の項目リスト}
```

### 7. 付録（オプション）

追加情報や参考資料。

```markdown
## 付録

### A. 用語集
- **循環的複雑度（CC）**: {説明}
- **結合度**: {説明}
- **凝集度**: {説明}

### B. 参考リンク
- [SOLID原則について](リンク)
- [コードスメルカタログ](リンク)
- [リファクタリング手法](リンク)

### C. 分析設定
- **除外パターン**: {node_modules/, dist/, build/等}
- **分析深度**: {クイック/標準/詳細}
- **言語**: {検出された言語リスト}
```

---

## 優先度定義

### Critical（緊急）

**定義**: 即座に対処が必要な重大な問題。

**判定基準**:
- セキュリティ脆弱性（SQL Injection, XSS, CSRF等）
- データ破損のリスク（トランザクション管理の欠如等）
- システム障害のリスク（メモリリーク、無限ループ等）
- 循環依存（モジュール間の循環参照）
- 致命的なバグの温床

**表示形式**:
```markdown
### [RF-001] セキュリティ: SQLインジェクションの脆弱性

**ファイル**: `src/database/query.js`
**行**: 45-52
**優先度**: Critical
**カテゴリ**: セキュリティ脆弱性
```

**アイコン/色**:
- 🔴 赤色
- ⚠️ 警告マーク

---

### High（高）

**定義**: できるだけ早く対処すべき重要な問題。

**判定基準**:
- SOLID原則の重大な違反（特にSRP、OCP）
- 大規模な重複コード（50行以上の重複が3箇所以上）
- 極端に高い複雑度（CC > 15、認知的複雑度 > 15）
- 大きすぎるクラス/メソッド（500行以上、100行以上）
- 重要な設計原則の違反
- パフォーマンス問題

**表示形式**:
```markdown
### [RF-002] 単一責任原則違反: UserServiceの責任過多

**ファイル**: `src/services/UserService.ts`
**行**: 1-350
**優先度**: High
**カテゴリ**: SOLID原則違反
**サブカテゴリ**: Single Responsibility Principle
```

**アイコン/色**:
- 🟠 オレンジ色
- ⚡ 高優先度マーク

---

### Medium（中）

**定義**: 計画的に対処すべき問題。

**判定基準**:
- 命名の問題（不明瞭、誤解を招く）
- 中程度の複雑度（CC 10-15、認知的複雑度 10-15）
- データクランプ
- ネストの深さ（4階層以上）
- Switch文の乱用
- 中規模の重複コード
- 一時的なフィールド
- Feature Envy

**表示形式**:
```markdown
### [RF-005] コードスメル: Long Parameter List

**ファイル**: `src/utils/helpers.js`
**行**: 23
**優先度**: Medium
**カテゴリ**: コードスメル
**サブカテゴリ**: Long Parameter List
```

**アイコン/色**:
- 🟡 黄色
- 📊 中優先度マーク

---

### Low（低）

**定義**: 余裕があれば対処すべき軽微な問題。

**判定基準**:
- コメント不足（複雑なロジックの説明がない）
- マジックナンバー（定数化すべき数値）
- 一貫性のないフォーマット
- 軽微な最適化機会
- デッドコード（未使用だが害はない）
- 命名の軽微な改善
- 小規模な重複（10行未満）

**表示形式**:
```markdown
### [RF-012] マジックナンバー: 定数化推奨

**ファイル**: `src/config/constants.js`
**行**: 67
**優先度**: Low
**カテゴリ**: コードスタイル
**サブカテゴリ**: Magic Numbers
```

**アイコン/色**:
- 🟢 緑色
- ℹ️ 情報マーク

---

## レポートの例

### 最小限のレポート例

```markdown
# リファクタリング分析レポート

**分析対象**: my-project/src
**分析日時**: 2026-01-30 14:30:00
**検出項目数**: 8 (Critical: 0, High: 2, Medium: 4, Low: 2)

## エグゼクティブサマリー

### 全体評価
- **コード品質スコア**: 68 / 100点
- **保守性**: 改善推奨

### 主要な問題
1. UserServiceクラスが複数の責任を持っている（SRP違反）
2. 認証ロジックに50行の重複コードが存在

### 推奨アクション
1. UserServiceを責任ごとに分割
2. 共通認証ロジックを抽出

## 検出項目サマリー

| 優先度 | 件数 | 主な問題カテゴリ |
|--------|------|------------------|
| High | 2 | SOLID原則違反, 重複コード |
| Medium | 4 | 命名問題, 複雑度 |
| Low | 2 | マジックナンバー |

## 詳細

### [RF-001] 単一責任原則違反: UserServiceの責任過多

**ファイル**: `src/services/UserService.ts`
**行**: 1-250
**優先度**: High
**カテゴリ**: SOLID原則違反
**サブカテゴリ**: Single Responsibility Principle

#### 問題の説明
UserServiceが認証、プロファイル管理、メール送信の3つの責任を持っています。
単一責任原則に違反しており、変更時の影響範囲が広くなっています。

#### 現在のコード
```typescript
class UserService {
  async authenticate(email, password) { ... }
  async updateProfile(userId, data) { ... }
  async sendWelcomeEmail(userId) { ... }
  // 250行のクラス
}
```

#### 改善後のコード
```typescript
// 責任ごとに分割
class AuthService {
  async authenticate(email, password) { ... }
}

class ProfileService {
  async updateProfile(userId, data) { ... }
}

class EmailService {
  async sendWelcomeEmail(userId) { ... }
}
```

#### 改善の効果
- 各サービスが単一責任を持つ
- テストが容易になる
- 変更の影響範囲が限定される
- チーム並行開発が可能になる

#### 実装の影響範囲
- **変更ファイル数**: 4（新規3、修正1）
- **影響するテスト**: UserService.test.tsを3つに分割
- **破壊的変更**: なし（インターフェース互換性を保つ）
- **推定工数**: 中

---

{他の問題も同様の形式で続く}
```

---

## 出力のカスタマイズ

### フィルタリングオプション

ユーザーの要求に応じて以下をフィルタリング:

1. **優先度フィルタ**: 「Criticalのみ表示」
2. **カテゴリフィルタ**: 「SOLID違反のみ」
3. **ファイルフィルタ**: 「特定ディレクトリのみ」
4. **複雑度フィルタ**: 「CC > 10のみ」

### 出力形式バリエーション

1. **詳細レポート**: 全セクション含む（デフォルト）
2. **サマリーのみ**: ヘッダー、サマリー、推奨アクションのみ
3. **問題リストのみ**: 詳細セクションのみ
4. **JSON形式**: CI/CD統合用の機械可読形式

### JSON形式の例

```json
{
  "summary": {
    "target": "my-project/src",
    "timestamp": "2026-01-30T14:30:00Z",
    "total_issues": 8,
    "by_priority": {
      "critical": 0,
      "high": 2,
      "medium": 4,
      "low": 2
    },
    "quality_score": 68
  },
  "issues": [
    {
      "id": "RF-001",
      "title": "単一責任原則違反: UserServiceの責任過多",
      "file": "src/services/UserService.ts",
      "lines": "1-250",
      "priority": "high",
      "category": "SOLID違反",
      "subcategory": "Single Responsibility Principle",
      "description": "...",
      "current_code": "...",
      "improved_code": "...",
      "effects": ["...", "..."],
      "metrics": {
        "cyclomatic_complexity": null,
        "lines_of_code": 250
      }
    }
  ]
}
```

---

## ベストプラクティス

### レポート作成時の注意点

1. **具体性**: 抽象的な指摘ではなく、具体的なコード例を示す
2. **優先順位付け**: 重要な問題を見逃さないよう適切に優先度を設定
3. **実装可能性**: 現実的に実装可能な改善案を提示
4. **影響範囲の明示**: 変更の影響を明確に記述
5. **段階的改善**: 一度に全てを変更するのではなく、段階的なアプローチを推奨

### ユーザーコミュニケーション

1. **確認**: レポート生成前にスコープと深さを確認
2. **カスタマイズ**: ユーザーのニーズに応じてフォーマットを調整
3. **フォローアップ**: 実装支援が必要か確認
4. **優先度の説明**: なぜその優先度なのかを明確に説明
