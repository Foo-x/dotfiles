# サンプリング戦略ガイド

テストケース生成において、トレース集合は一般に無限または巨大であるため、網羅的な列挙は不可能。本ファイルではリスクベースサンプリングを中心に、体系的なテストケース選択戦略を定義する。

## 目次

1. [リスクベース優先度付け](#リスクベース優先度付け)
2. [等価クラス分割](#等価クラス分割)
3. [境界値分析](#境界値分析)
4. [構造カバレッジ基準](#構造カバレッジ基準)
5. [安全性フォーカスサンプリング](#安全性フォーカスサンプリング)
6. [サンプリング戦略の選択ガイド](#サンプリング戦略の選択ガイド)

---

## リスクベース優先度付け

リスク = 故障確率 × 故障影響度。以下の順に受理テストケースを選ぶ:

### 優先度1: ビジネスクリティカルフロー

**定義:** システムの主要ユースケースを実現するトレース。

**識別方法:**
- ユーザーストーリーの主経路（ハッピーパス）
- SLAや契約で保証されている機能
- 障害時のビジネス影響が最大のフロー

**例:**
```
自販機: ⟨coin(100), coin(50), button_A⟩  → A商品購入の正常系
ログイン: ⟨input_id, input_password, submit⟩  → 通常ログイン
```

### 優先度2: 活性・到達可能性の証明

**定義:** 機能要求で「いつか起こるべき」「到達できるべき」とされたトレース。

**識別方法:**
- 機能要求の活性・到達可能性の記述を参照
- 各最終状態（ゴール状態）への最短パス

**例:**
```
機能要求: 「製品Aの価格以上の貨幣を投入するとボタンを押せる状態になる」
対応トレース: ⟨coin(200), button_A⟩（price_A = 150 の場合）
```

### 優先度3: ガード条件の各分岐

**定義:** ガード条件が真/偽それぞれの場合を網羅するトレース。

**識別方法:**
- 状態機械の各遷移のガード条件を列挙
- 各ガードが真になる最短トレースと、偽になる状況

**例:**
```
遷移: waiting --[button_A] [total >= price_A] --> dispensing
ガード真: ⟨coin(200)⟩ を経た後に ⟨button_A⟩（total=200 >= price_A=150）
ガード偽: ⟨coin(100)⟩ を経た後に ⟨button_A⟩ は拒否（total=100 < price_A=150）
```

### 優先度4: 状態変数の境界値

**定義:** ガード条件の境界付近の値を持つトレース（詳細は境界値分析セクション参照）。

### 優先度5: ループ・繰り返しの代表例

**定義:** 繰り返し可能な遷移について、0回・1回・複数回のサイクルを含むトレース。

**例:**
```
コイン投入の繰り返し:
  0回ループ（直接ボタン）: 拒否テストケースになる
  1回: ⟨coin(200), button_A⟩
  複数回: ⟨coin(100), coin(100), button_A⟩
```

### 優先度6: 並行合成の同期点

**定義:** 複数コンポーネントが同期するイベントを含むトレース。

**識別方法:**
- API呼び出し・レスポンスのペア
- クライアント↔サーバーの通信イベント
- 在庫確認などの外部システム同期

---

## 等価クラス分割

状態変数の値空間を意味的に等価なグループ（等価クラス）に分割し、各クラスから1つのトレースを選ぶ。

### 分割の基準

ガード条件 `[cond(v)]` に基づき、状態変数 `v` の値空間を分割:

| クラス | 条件 | 意味 |
|-------|------|------|
| 正常クラス1 | cond(v) が真 | ガード通過可能 |
| 正常クラス2 | cond(v) が偽 | ガード通過不可（別の遷移が可能かも） |
| 異常クラス | v が定義域外 | 型違反・NULL等 |

### 例: ログインの試行回数

```
状態変数: attempt_count: Int = 0
ガード: [attempt_count < 3]（3回未満なら再試行可能）

等価クラス:
  クラスA（ガード真）: attempt_count ∈ {0, 1, 2} → 再試行可能
  クラスB（ガード偽）: attempt_count ∈ {3, 4, ...} → アカウントロック
```

各クラスから代表値を1つ選んでテストケースを生成する。

---

## 境界値分析

ガード条件の境界値付近で動作が変わるため、境界点・直前・直後を必ずテストする。

### 境界値の選択則

ガード `[v >= threshold]` に対して:

| テスト値 | 期待結果 | 理由 |
|---------|---------|------|
| `v = threshold` | 受理（ガード真） | 境界値ちょうど |
| `v = threshold - 1` | 拒否（ガード偽） | 境界値の直前 |
| `v = threshold + 1` | 受理（ガード真） | 境界値の直後 |

### 例: 自販機の価格境界

```
price_A = 150、ガード [total >= price_A]

境界テストケース:
  A-B1: ⟨coin(150), button_A⟩  → 受理（total=150 = price_A）
  R-B1: ⟨coin(149), button_A⟩  → 拒否（total=149 < price_A）
  A-B2: ⟨coin(100), coin(51), button_A⟩  → 受理（total=151 > price_A）
```

### 複数の境界条件が絡む場合

ガード `[v1 >= t1 and v2 < t2]` では、境界の組み合わせを考慮する:
- (v1=t1, v2=t2-1): 両方境界値
- (v1=t1-1, v2=t2-1): v1のみ境界違反
- (v1=t1, v2=t2): v2のみ境界違反

---

## 構造カバレッジ基準

状態機械の構造要素を網羅するテストケースセットを設計する。

### 状態カバレッジ（SC: State Coverage）

**目標:** すべての状態を少なくとも1回訪問するトレースセット。

**方法:** 各状態への最短到達トレースを生成。

**例（自販機）:**
```
状態: {idle, waiting, dispensing, error}
SC達成:
  idle: ε（初期状態）
  waiting: ⟨coin(100)⟩
  dispensing: ⟨coin(200), button_A⟩
  error: ⟨coin(1000)⟩（満額エラーなど）
```

### 遷移カバレッジ（TC: Transition Coverage）

**目標:** すべての遷移を少なくとも1回実行するトレースセット。

**方法:** 各遷移のガード条件を真にする最短トレースを生成。

SC ⊂ TC（状態カバレッジは遷移カバレッジに含意されない）。

### 有界パスカバレッジ（BPC: Bounded Path Coverage）

**目標:** 長さNまでの全パスを網羅する。

**実用:** N=2 〜 4 が現実的。仕様の状態数に応じて調整する。

**注意:** ループを持つ状態機械では指数的に増加するため、ループの展開回数を制限する。

---

## 安全性フォーカスサンプリング

安全性要求（「悪いことが決して起こらない」）の検証に特化した拒否テストケース生成戦略。

### 戦略1: ガード否定テスト

**手法:** 各ガード付き遷移について、ガードが偽の状態でそのイベントを送信する。

```
遷移: waiting --[button_A] [total >= price_A] --> dispensing
テスト: total < price_A の状態で button_A → 拒否されることを確認
```

### 戦略2: イベント順序逸脱テスト

**手法:** 有効なトレースのイベント順序を並び替えて、不正な順序が拒否されることを確認。

```
有効: ⟨coin(200), button_A⟩
順序逸脱: ⟨button_A, coin(200)⟩ → 拒否
```

### 戦略3: 禁止シーケンステスト

**手法:** 安全性要求が明示的に禁じているシーケンスを構成する。

```
安全性要求: 「投入貨幣の総額より価格の高い製品は購入可能にならない」
禁止シーケンス: total < price_A の状態での ⟨button_A⟩ → 拒否
```

### 戦略4: 失敗集合直接活用

**手法:** `failures(P)` から `(s, X)` を取り出し、トレース `s` 後にイベント `e ∈ X` を送信するテストケースを生成する。

```
失敗: (⟨⟩, {button_A, button_B})
→ 初期状態でのボタン押下は全て拒否
テスト: ⟨button_A⟩ → 拒否、⟨button_B⟩ → 拒否
```

### 戦略5: デッドロック・活性違反テスト（拡張）

**手法:** すべてのイベントが拒否される状態（デッドロック状態）に至るトレースを特定し、そこからの回復手段がないことを確認する。

```
（仕様でデッドロックが許容されない場合）
デッドロック状態に至るトレースを受理テストケースとして記録しつつ、
「そこからどのイベントも拒否される」という拒否テストケースを追加
```

---

## サンプリング戦略の選択ガイド

| 状況 | 推奨戦略 |
|-----|---------|
| 初回テスト設計 | リスクベース優先度1〜3 + 遷移カバレッジ |
| セキュリティ重視 | 安全性フォーカスサンプリング（全5戦略） |
| 状態変数が多い | 等価クラス分割 + 境界値分析 |
| 並行システム | リスクベース優先度6 + 同期点の失敗集合活用 |
| 回帰テスト最小化 | リスクベース優先度1〜2 のみ |
| 完全なカバレッジ要求 | 有界パスカバレッジ (BPC, N=状態数) |
