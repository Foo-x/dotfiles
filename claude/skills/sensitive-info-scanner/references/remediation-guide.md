# 検出後の対応ガイド

検出された機微情報の種類に応じた対応方法を記載したガイドです。
「即時対応」「短期対応」「長期対応」に分類されています。

---

## 1. 即時対応

検出した瞬間に対応が必要なもの。放置すると実害になる可能性が高い。

### AWS 認証情報
- **AWS Access Key ID / Secret Access Key** が検出された場合：
  1. AWS IAM Console で該該キーを即座に**無効化**する
  2. キーが使われていたサービスの権限を確認し、不正アクセスがないか確認する
  3. キーを環境変数やAWS Secrets Managerに移行する
  4. コミット履歴からキーを削除する（`git filter-branch` や`BFG Repo Cleaner`を使用）

### GitHub トークン
- **GitHub PAT (`ghp_...`) / OAuth (`gho_...`)** が検出された場合：
  1. GitHub設定で該該トークンを即座に**取り消す**
  2. トークンが持っていた権限のスコープを確認する
  3. 環境変数に移行し、再生成する

### Stripe ライブキー
- **`sk_live_...`** が検出された場合：
  1. Stripe Dashboard でキーを即座に**回転**する
  2. 古いキーを無効化する
  3. 環境変数に移行する

### SSH / PEM 秘密鍵
- **`-----BEGIN ... PRIVATE KEY-----`** が検出された場合：
  1. 秘密鍵をリポジトリから削除する
  2. `.gitignore` に `*.pem`, `*.key`, `id_rsa` 等を追加する
  3. 鍵を再生成し、公開鍵認証を再設定する
  4. コミット履歴から鍵を削除する

### DB接続文字列
- **`postgres://`, `mysql://` 等に実パスワード入り** が検出された場合：
  1. DBパスワードを即座に**変更**する
  2. 接続文字列を環境変数に移行する
  3. 環境変数管理のためにシークレット管理サービスを導入する

### クレジットカード番号
- **カード番号** が検出された場合：
  1. 番号を即座にコードから削除する
  2. カード番号がテスト用かどうかを確認する
  3. 実カード番号であればカード会社に連絡し、不正利用チェックを要求する
  4. 情報漏洩の経緯を確認し、必要に応じて報告する

### マイナンバー
- **12桁のマイナンバー** が検出された場合：
  1. 番号を即座にコードから削除する
  2. 本人に情報漏洩を通知する
  3. 個人情報保護の観点から適切な報告を行う

---

## 2. 短期対応

リスクは存在するが、即時対応ほどの緊急性はない。数時間〜1日以内に対応する。

### Stripe テストキー
- **`sk_test_...`** が検出された場合：
  1. テスト環境なのでリスクは低い
  2. 環境変数に移行する
  3. 長期的にはCI/CDのシークレット管理に統合する

### Slack / SendGrid / Twilio トークン
- **Slack (`xox...`), SendGrid (`SG....`), Twilio (`AC...`)** が検出された場合：
  1. 各サービスのダッシュボードで該該トークンの有効性を確認する
  2. 有効であればトークンを回転させる（再生成）
  3. 環境変数に移行する

### JWTトークン
- **`eyJ...`** が検出された場合：
  1. JWTの有効期限（`exp`クレーム）を確認する
  2. 期限切れでなければ、サーバー側で無効化する
  3. 今後はトークンを環境変数やシークレット管理に移行する

### パスワード代入
- **変数にパスワード実値が代入されている** 場合：
  1. パスワードを変更する
  2. 環境変数やシークレット管理に移行する
  3. 他のサービスで同じパスワードを使用していないか確認する

### 汎用APIキー
- **サービス特定できない APIキー** が検出された場合：
  1. キーの所属サービスを確認する
  2. サービス側でキーの有効性と利用状況を確認する
  3. 環境変数に移行し、古いキーを無効化する

---

## 3. 長期対応

リスクは低いが、改善すべき技術的負債として対応する。

### メールアドレス
- **メールアドレス** がコード内にハードコードされている場合：
  1. 設定ファイルやDBに移動する
  2. 環境変数での管理を検討する
  3. テスト用メールアドレスであればモックに置換する

### テストコンテキスト内の機密情報
- **テスト配下で検出された機密情報** の場合：
  1. テスト用のダミー値やモックに置換する
  2. `tests/fixtures/` 等に格納する際は実値を使わない
  3. CI/CDでのテスト実行時はシークレットの環境変数を使用する

### 電話番号
- **電話番号** がコード内にハードコードされている場合：
  1. 設定ファイルやDBに移動する
  2. テスト用であればダミー番号に置換する

---

## 4. ベストプラクティス（再発防止）

### 環境変数の活用
機密情報は常に環境変数で管理し、コードにハードコードしない。
```
# NG
API_KEY = "sk_live_xxxxx"

# OK
API_KEY = os.getenv("STRIPE_API_KEY")
```

### シークレット管理サービスの導入
規模や環境に応じて以下のサービスを活用する。
- **AWS**: Secrets Manager / SSM Parameter Store
- **GCP**: Secret Manager
- **Azure**: Key Vault
- **汎用**: HashiCorp Vault, Doppler, 1Password Secrets Automation

### .gitignore の設定
以下のパターンを `.gitignore` に追加し、機密ファイルのコミットを防止する。
```
.env
.env.*
!.env.example
*.pem
*.key
*.p12
*.pfx
secrets.*
credentials.*
id_rsa
id_ed25519
id_ecdsa
*.keystore
```

### コミット前チェック
- `pre-commit` フックで機密情報スキャンを実行する
- CI/CDパイプラインにセキュリティスキャンステップを追加する
- `git-secrets` や `trufflehog` 等のツールの導入も検討する
