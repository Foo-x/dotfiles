# 理論的枠組み: 要求定義・仕様記述の基礎

> 本文書は「要求定義・仕様記述・設計・検証の手引き」（Kuniwak著）の理論的内容を凝縮した参照資料。
> CSP安定失敗モデル・Michael Jacksonの要求理論・Meyer's DbCに基づく。

---

## 1. 機能要求の3性質

**機能要求**とはトレース集合の満たすべき性質の定義。以下の3種類に分類される。

### 活性（Liveness）

- **定義**: いつかいいことが起こる性質
- **形式**: 「イベントX（およびY）が起こると、いつかイベントWが発生する」
- **判別基準**: 「～するといつか～が起こる」「～を行うと最終的に～になる」という構造
- **例**: 「売り切れでない製品Aの価格より多く貨幣を投入してボタンを押すと、いつか製品Aを受け取れる」

### 到達可能性（Reachability）

- **定義**: トレース集合の中に条件を満たすトレースが存在する
- **形式**: 「条件Cを満たすトレースが少なくとも1つ存在する」
- **判別基準**: 活性だけでは「実は何もできない」システムでも満たせてしまうため、「そのトレースが実際に実行可能である」ことを保証する
- **必要性**: 活性は「もし～が起きたらいつかWが起きる」という形だが、「～が起きられること自体」は保証しない。到達可能性が対になって初めて意味を持つ
- **例**: 「売り切れでない製品Aを購入できる状態に到達できる（購入可能になるトレースが存在する）」

### 安全性（Safety）

- **定義**: 悪いことが決して起こらない性質
- **形式**: 「イベントXは発生しない」または「X, Yが起きた後にWは発生しない」
- **判別基準**: 「～は絶対に起きない」「～した後は～できない」という禁止・不変条件の構造
- **例**: 「投入貨幣の総額より価格の高い製品は購入可能にならない」

### 判別チャート

```
その要求は...
├─ 「～するといつか～が起こる」形式? → 活性
├─ 「～な状態/動作が可能である」形式? → 到達可能性
└─ 「～は発生しない / ～後に～は起きない」形式? → 安全性

数値・量・速度・負荷の指標が含まれる? → 非機能要求
```

---

## 2. 非機能要求

**非機能要求**とは量的な指標でしか記述できない性質（真偽で決定できない）の定義。

- **遷移にかかる時間**: 「XmsecでYが返ること」（機能要求「YがいつかZになる」と区別される）
- **計算機資源の負荷**: CPU使用率・メモリ使用量の上限
- **使用性**: 主要なユーザーストーリー達成に必要なUIイベント数、視線の動きの総量

**注意**: 「なるべく」「素早く」「正確に」などの曖昧な修飾語は非機能要求の未完成形。必ず量的指標に変換する必要がある。

---

## 3. 成果物の階層と詳細化の関係

```
機能要求（活性・到達可能性・安全性で記述）
  ↓ 制約
トップレベル仕様（トレース集合と失敗集合の組）
  ↓ 分解
コンポーネント仕様1, 2, 3, ...（設計）
  ↓ 並行合成 ⊆ 上位のトレース集合・失敗集合
コンポーネント実装1, 2, 3, ...
  ↓ 並行合成

非機能要求 → 遷移時間・資源使用量などの統計で制約 → 実装
```

**詳細化の原則**:
- 各レベルの成果物は上位レベルの制約を満たす（推移律）
- 上位で定義していない振る舞いは下位で自由に定義できる
- 仕様は機能要求より多くを定義する（未言及トレースも定義する）

---

## 4. トレース集合・失敗集合の概念

### トレース

- **定義**: 初期状態から連続的に遷移可能なイベントの列から内部イベント τ を取り除いたもの
- **トレース集合**: 状態機械が出せるすべてのトレースの集まり

### 安定状態と失敗

- **安定状態**: 内部イベント τ で遷移できない状態
- **失敗**: 「安定状態に至るトレース」と「その安定状態で拒否されるイベントの集合」の組
- **失敗集合**: すべての失敗を集めたもの

### 仕様との関係

仕様のトレース集合が機能要求を満たすとは:
1. 含まれるべきトレース（活性・到達可能性で要求されたもの）がすべて含まれている
2. 含まれてはならないトレース（安全性で禁止されたもの）がすべて含まれていない

---

## 5. 自販機の具体例

### システム概要

飲料自販機。ユーザーが貨幣を投入し、製品を選択して購入できる。

### 良い要求の例

| 性質 | 要求 |
|------|------|
| 到達可能性 | 売り切れでない製品Aの価格より多く貨幣を投入すると製品Aが購入可能になる |
| 活性 | 製品Aが購入可能な状態でボタンを押すと、いつか製品Aを受け取れる |
| 安全性 | 投入貨幣の総額より価格の高い製品は購入可能にならない |

※到達可能性と活性はペアで機能することに注目。

### 悪い要求の例（過剰仕様）

- ❌ 「製品Aのボタンを押した場合、0.5秒以内に製品Aを排出する」
  → これは仕様・実装レベルの話。0.5秒という制約は非機能要求として分離すべき
- ❌ 「貨幣投入→製品選択→排出の順でのみ操作できる」
  → 操作順序の制約は仕様が決めること。要求の時点で未言及トレースを定義してはいけない

### テストケースの例

- テストケースA: 貨幣投入①→貨幣投入②→製品選択③→製品排出④→**受理**（活性の検証）
- テストケースB: 製品選択①→**拒否**（安全性の検証：投入なしでの購入を拒否）

---

## 6. 要求 vs 仕様の境界

**機能要求**: 言及されていないトレースがどうなっているかは**未定義**。

**仕様**: 機能要求で未言及の部分も含め、すべての振る舞いを定義する。

### 過剰仕様（Over-specification）の例

要求が仕様の領域に踏み込んだ例:

| 過剰仕様 | 問題点 |
|---------|--------|
| 「エラー時は必ずモーダルダイアログを表示する」 | 表示方法（UI）は仕様の領域 |
| 「Xイベントの後は必ずYイベントが来なければならない」 | 状態遷移の強制は仕様の領域 |
| 「タイムアウトは30秒で固定する」 | 具体的な時間値は非機能要求または仕様の領域 |

### 適切な要求の書き方

- ✅ 「エラー状態の場合、ユーザーはいつかその旨を認識できる」（活性）
- ✅ 「エラーが発生している間、通常の操作は受け付けない」（安全性）

---

## 参考文献

1. Michael Jackson「ソフトウェア要求と仕様: 実践, 原理, 偏見の辞典」
2. 磯部祥尚「並行システムの検証と実装：形式手法CSPに基づく高信頼並行システム開発入門」
3. Bertrand Meyer「オブジェクト指向入門 第2版 原則・コンセプト」
