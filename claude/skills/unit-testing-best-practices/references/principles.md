# Unit Testing Principles

単体テストの詳細原則と実践ガイド。

---

## FIRST 原則

すべての単体テストは以下の5つの原則を満たすべき。

| 原則 | 意味 | ポイント |
|------|------|----------|
| **F**ast | 高速に実行される | 外部I/O、ネットワーク、スリープなしで実行 |
| **I**ndependent | 他のテストに依存しない | 実行順序に関わらず同じ結果 |
| **R**epeatable | 毎回同じ結果になる | 環境や時刻に依存しない |
| **S**elf-validating | 自動で合格/失敗を判定 | アサーションで明確に検証 |
| **T**imely | 適切なタイミングで書く | 実装と同期して作成・維持する |

---

## テスト構造: AAA パターン

すべてのテストは **Arrange → Act → Assert** の3つのブロックで構成する。

```
# Arrange: テスト用データやセットアップ（最小限に）
user = create_user(name="Alice", role="admin")

# Act: 検証対象の1つのアクション
result = user.can_delete_posts()

# Assert: 期待結果の検証
assert result == True
```

**規則:**
- Actは1つのアクションのみにする
- Assertは「何が期待されるか」を明確に表現する
- コメントでAAA各段落の境界を示すのは必須ではない

---

## テスト命名規則

テスト名には「何を・条件・期待結果」を含める。以下のパターンを参考にする。

```
test_[対象]_[条件]_[期待結果]

例:
  test_user_login_with_valid_credentials_returns_token
  test_order_total_with_discount_applies_percentage
  test_email_validation_rejects_empty_string
```

短くても読みにくい名前は避ける。明確さを優先する。

---

## モック・スタブの使用指針

モックは「依存関係の置き換え」のためのツールだが、過度使用は検証の意味を失わせる。

| 使うべき場合 | 使わないべき場合 |
|-------------|-----------------|
| 外部サービス（DB, API, ファイルシステム） | ロジックが薄い単純なデータクラス |
| テスト実行を遅くするリソース | 実装の内部ステップを検証するため |
| 非決定的な動作（時刻、乱数） | モック自体の動作を検証するため |

**原則:** モックは依存関係の「境界」に配置する。テスト対象の内部collaboratorをモックにすると、実装変更で簡単にテストが壊れる。

---

## 境界値・エラーケースのカバー

正常系のみでは不十分。以下のカテゴリを意識してテスト設計する。

- **正常系:** 典型的な入力で期待通りの動作
- **境界値:** 空文字列、null、0、最大値、最小値、負数
- **エラー系:** 不正入力、例外発生、外部障害
- **エッジケース:** 重複データ、同時実行、長い入力値、削除済みデータ、空白、特殊文字、キャッシュ
