# Unit Testing Anti-Patterns

以下はよくある単体テストのアンチパターンと、その改善方法です。

---

## 1. Invasive Test (侵入的なテスト)

**問題:** テスト実行のために製品コードの構造や内部実装を変更する。

```
// 悪い例: テスト用のonly-for-testメソッドを追加
class UserService:
    def _internal_helper():  # テスト用にprivateをpublicにしている
        ...
```

**改善:** テストは公開インターフェースを通じて検証する。内部実装が直接テスト可能にならない場合は設計を見直す。

---

## 2. Test Duplication (テストの重複)

**問題:** 同じシナリオを検証する複数のテストが存在し、維持コストが増加する。

**改善:** テストの目的を明確にし、各テストが一つの動作のみを検証するようにする。共通のセットアップはヘルパーに抽象化する。

---

## 3. Eerie Spectre (幽霊のような依存関係)

**問題:** テストが見えない外部の状態や共有リソースに依存し、実行順序や環境によって結果が変わる。

**改善:** テスト間で共有状態を排除する。各テストが必要なデータを自己で準備し、後片付けを行う。

---

## 4. Generous Fixture (過度なセットアップ)

**問題:** テストに必要以上のセットアップ・データを用意する。テスト自体がどこで失敗しているのか分かりにくくなる。

**改善:** 各テストに必要な最小限のデータだけを準備する。Builder パターンやFactory を活用。

---

## 5. Mystery Guest (謎のゲスト - ハードコード依存)

**問題:** テスト内のアサーション値がどこから来たのか分からない。

```
// 悪い例
assert result == 3.14159

// 良い例
expected_pi_approx = math.pi
assert round(result, 5) == round(expected_pi_approx, 5)
```

**改善:** 期待値には明確な変数名を使い、意味を示す。

---

## 6. Sensitive Equality (過度な一致検証)

**問題:** オブジェクトの全フィールドを一致検証する。関係ないフィールドの変更でテストが壊れる。

**改善:** 検証対象のフィールドのみ確認する。オブジェクト比較には custom matcher やアサーション関数を使う。

---

## 7. Long Test (長いテスト)

**問題:** テストメソッドが長すぎて読みにくい。

**改善:** ヘルパーメソッドに分けたり、テストデータビルダーを活用したりする。

---

## 8. Conjugated Class (共役クラス - 過度モック)

**問題:** 依存関係のすべてをモックにして、実際の動作が検証されなくなる。

```
// 悪い例: 全てをモックにして意味のない検証になっている
mock_db = Mock()
mock_logger = Mock()
mock_email = Mock()
result = create_user(mock_db, mock_logger, mock_email)
assert mock_db.called  # 何も実際には検証されていない
```

**改善:** モックは必要な依存関係のみに限定する。「動作の検証」と「連携の検証」で用途を分ける。

---

## 9. Eager Test (貪欲なテスト)

**問題:** 1つのテストメソッドが複数の関心事を検証している。

**改善:** 関心事ごとにテストメソッドを分割し、各テストは1つの振る舞いのみを検証する。

---

## 10. Obscure Test (不明瞭なテスト)

**問題:** テストの意図や挙動が理解しにくい。

**改善:** 意味のある定数・変数名を使用したり、テストデータビルダーパターンを導入したり、AAA（Arrange-Act-Assert）パターンを明確にしたりする。

---

## 11. Conditional Test Logic (条件分岐のあるテスト)

**問題:** テストコード内にif文やswitch文などの条件分岐がある。

**改善:** パラメータ化テストへの変換、またはテストケースを分割する。

---

## 12. Test Run War (テスト実行の競合)

**問題:** 複数のテストが同じリソース（ファイル、ポート、DB）を奪い合う。

**改善:** ユニークなリソース識別子の生成、テンポラリファイルの使用、ポート番号の動的割り当て。
