# use in your .bash_profile or .bashrc like below
# . /path/to/dotfiles/.aliases_fzf

function cdh() {
  local target=$(dirs -v | sort -k 2 | uniq -f 1 | sort -n -k 1 | cut -d" " -f3- | sed 's/^ *//' | fzf --bind "shift-up:page-up,shift-down:page-down")

  if [ -n "$target" ]; then
    cd "$(echo "$target" | sed "s;^~;$HOME;")"
  fi
}

function cdi() {
  case $1 in
    help|--help|-h)
      echo "cd interactively."
      echo ""
      echo "  Ctrl-k/Ctrl-p/up      : up"
      echo "  Ctrl-j/Ctrl-n/down    : down"
      echo "  PgUp/Shift-up         : page up"
      echo "  PgDn/Shift-down       : page down"
      echo "  Space/Shift-right     : cd and continue"
      echo "  Ctrl-Space/Shift-left : cd to parent and continue"
      echo "  Enter                 : cd and exit"
      echo "  Esc                   : abort"
      return
      ;;
  esac

  local cd_and_continue='execute-silent@cd "`cat /tmp/fzf_cur | sed "s/^ *//"`" && cd {} && pwd > /tmp/fzf_cur@+top+clear-query+reload@cd "`cat /tmp/fzf_cur`" && echo "`pwd`" && printf "%s\n" {./,{.,}?*/} | grep -v "*"@'
  local cd_to_parent_and_continue=${cd_and_continue/\{\}/..}

  pwd > /tmp/fzf_cur
  local target=$((echo "`pwd`" && printf "%s\n" {./,{.,}?*/}) | fzf --header-lines=1 --bind "space:${cd_and_continue},ctrl-space:${cd_to_parent_and_continue},shift-right:${cd_and_continue},shift-left:${cd_to_parent_and_continue},shift-up:page-up,shift-down:page-down")

  if [ -n "$target" ]; then
    cd "$(echo "$(cat /tmp/fzf_cur)"/"$target")"
  fi
}

function gfco() {
  local tags branches target
  branches=$(
    git --no-pager branch --all \
      --format="%(if)%(HEAD)%(then)%(else)%(if:equals=HEAD)%(refname:strip=3)%(then)%(else)%1B[0;34;1mbranch%09%1B[m%(refname:short)%(end)%(end)") || return
  tags=$(
    git --no-pager tag | awk '{print "\x1b[35;1mtag\x1b[m\t" $1}') || return
  target=$(
    (echo "$branches"; echo "$tags") | sed '/^$/d' |
    fzf --no-hscroll --no-multi -n 2 --header="current: [$(git symbolic-ref --short HEAD 2> /dev/null || echo 'detached HEAD')]" \
        --ansi --preview="git --no-pager log -150 --color --pretty=format:\"%s %C(black)%C(bold)%cr\" '..{2}'") || return
  git checkout $(awk '{print $2}' <<<"$target" )
}

function gfshow() {
  git log --graph --color=always \
      --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
  fzf --ansi --no-sort --reverse --tiebreak=index \
      --bind "ctrl-m:execute:
                (echo {} | grep -Eo '[a-f0-9]+' | head -1 |
                xargs -I % bash -c 'git show --color=always % | less -R')"
}
