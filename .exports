export HISTSIZE=100000
export HISTFILESIZE=100000
export HISTTIMEFORMAT='%F %T '
export HISTCONTROL=ignoreboth  # not save commands that space-beginned and duplicated to history
export HISTIGNORE='fg:bg:history:ls:ll:h:pwd:cd*:exit:clear'

if type vim &> /dev/null; then
  export EDITOR='vim -p'
else
  export EDITOR='vi -p'
fi

if type less &> /dev/null; then
  export PAGER='less'
  export LESS='RFMi'
fi

export SIMPLE_BACKUP_SUFFIX=.`date +%Y%m%d_%H%M%S`

[[ "${WSL_DISTRO_NAME}" ]] && export BROWSER=wslview

export LANG=C
LOCALE_LIST="$(locale -a)"
if [[ "${LOCALE_LIST}" == *C.UTF-8* ]]; then
  export LC_CTYPE='C.UTF-8'
fi

stty stop ''

export FZF_DEFAULT_OPTS='--reverse --cycle --bind "change:top" -0'

export ENHANCD_FILTER=fzf
export ENHANCD_DOT_ARG=...

# exec commands after each commands
function dispatch_prompt_command() {
  local f
  for f in ${!PROMPT_COMMAND_*}; do
    eval "${!f}"
  done
}
export PROMPT_COMMAND='dispatch_prompt_command'

export PROMPT_COMMAND_HISTSAVE='history -a'

function lsgit() {
  ls -A
  if [ "$(git rev-parse --is-inside-work-tree 2> /dev/null)" = "true" ] ; then
    echo
    git status -sb
  fi
}

function lsgit_cd() {
  if [ "${LSGIT_DIR:-${PWD}}" != "${PWD}" ]; then
    lsgit
  fi
  LSGIT_DIR=${PWD}
}
export PROMPT_COMMAND_LSGIT_CD='lsgit_cd'

trap '((cmdcnt++))' DEBUG
function lsgit_enter() {
  if [ $((lsgit_enter_cnt + 1)) = ${cmdcnt} ]; then
    lsgit
  fi

  lsgit_enter_cnt=${cmdcnt}
}
export PROMPT_COMMAND_LSGIT_ENTER='lsgit_enter'

# prompt
SCRIPT_DIR=$(cd $(dirname ${BASH_SOURCE:-$0}); pwd)

if type git &> /dev/null; then
    . ${SCRIPT_DIR}/git-prompt.sh

    # lighter
    export PS1='\n\[\033[92m\]\u \[\033[93m\]&:\j \[\033[94m\]\w\[\033[91m\]$(__git_ps1)\n$(if [[ $? == "0" ]]; then echo \[\033[92m\]:\); else echo \[\033[91m\]:\(; fi)\[\033[00m\] '

    # darker
    #export PS1='\n\[\033[32m\]\u \[\033[33m\]&:\j \[\033[34m\]\w\[\033[31m\]$(__git_ps1)\n$(if [[ $? == "0" ]]; then echo \[\033[32m\]:\); else echo \[\033[31m\]:\(; fi)\[\033[00m\] '

    GIT_PS1_SHOWDIRTYSTATE=1  # show if files are changed or not
    GIT_PS1_SHOWUPSTREAM=1  # show diff from upstream
    GIT_PS1_DESCRIBE_STYLE=branch  # show detached HEAD as relative to branch
fi
